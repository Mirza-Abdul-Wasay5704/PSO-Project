<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSO Fuel Station Finder</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f7fafd;
            color: #222;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: #003366;
            color: #FFD700;
            padding: 28px 20px 20px 20px;
            border-radius: 15px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.10);
            text-align: center;
            position: relative;
        }
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 8px;
            font-weight: 900;
            color: #FFD700;
            letter-spacing: 1px;
        }
        .pso-logo {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
        }
        .pso-logo img {
            height: 90px;
            width: auto;
            display: block;
        }
        .search-container {
            background: #fff;
            border-radius: 15px;
            padding: 25px 30px 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0,51,102,0.08);
        }
        .search-form {
            display: flex;
            flex-wrap: wrap;
            gap: 18px;
            align-items: flex-end;
            justify-content: center;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            min-width: 180px;
        }
        .input-group label {
            font-weight: 700;
            margin-bottom: 8px;
            color: #003366;
            font-size: 1rem;
        }
        .input-group input {
            padding: 12px 16px;
            border: 1.5px solid #bfc9d1;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .input-group input:focus {
            outline: none;
            border-color: #003366;
            box-shadow: 0 0 0 2px rgba(0, 51, 102, 0.10);
        }
        .search-btn {
            background: linear-gradient(90deg, #FFD700 60%, #ffe066 100%);
            color: #003366;
            border: none;
            padding: 14px 32px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            height: fit-content;
            box-shadow: 0 2px 8px rgba(0,51,102,0.08);
        }
        .search-btn:hover {
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 6px 18px rgba(0,51,102,0.13);
        }
        .search-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        #site-status {
            margin-top: 14px;
            text-align: center;
            font-weight: bold;
            font-size: 1.13rem;
            color: #003366;
            background: #e3e8ee;
            border-radius: 8px;
        }
        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
        }
        .map-container {
            background: #f7fafd;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,51,102,0.06);
            position: relative;
        }
        #map {
            height: 600px;
            width: 100%;
        }
        /* Site analysis below map styles */
        .site-analysis-below-map {
            margin-top: 18px;
            margin-bottom: 0;
            background: #f7fafd;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0,51,102,0.06);
            padding: 24px 24px 10px 24px;
            overflow: hidden;
            width: 100%;
        }
        .site-analysis-below-map .site-analysis-title {
            font-size: 1.3rem;
            font-weight: 900;
            color: #003366;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .site-analysis-below-map .site-status-row {
            font-size: 1.08rem;
            color: #003366;
            background: #e3e8ee;
            border-radius: 8px;
            padding: 10px 16px;
            margin-bottom: 18px;
            font-weight: 600;
            text-align: center;
        }
        .site-analysis-below-map .site-analysis-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 18px;
            width: 100%;
            box-sizing: border-box;
        }
        .site-analysis-below-map .site-analysis-item {
            background: #fff;
            border-radius: 10px;
            padding: 18px 12px;
            display: flex;
            align-items: center;
            gap: 14px;
            box-shadow: 0 1px 4px rgba(0,51,102,0.04);
            border: 1.5px solid #e3e8ee;
            min-width: 0;
            word-break: break-word;
        }
        .site-analysis-below-map .site-analysis-icon {
            font-size: 2rem;
            color: #003366;
            background: #e3e8ee;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .site-analysis-below-map .site-analysis-label {
            font-size: 1.05rem;
            font-weight: 700;
            color: #003366;
        }
        .site-analysis-below-map .site-analysis-count {
            font-size: 1.4rem;
            font-weight: 900;
            color: #166534;
            margin-left: auto;
        }
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .search-form {
                grid-template-columns: 1fr;
            }
            .header h1 {
                font-size: 2rem;
            }
            .site-analysis-below-map .site-analysis-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .station-details {
                grid-template-columns: 1fr;
            }
            .site-analysis-below-map .site-analysis-grid {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 600px) {
            .site-analysis-below-map .site-analysis-grid {
                grid-template-columns: 1fr;
            }
        }
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .stats-container {
            background: #f7fafd;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,51,102,0.06);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .stat-card {
            background: #fff;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            color: #003366;
            border: 1.5px solid #e3e8ee;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: 900;
            color: #006400;
        }
        .stat-label {
            font-size: 0.9rem;
            color: #003366;
            margin-top: 5px;
        }
        .results-container {
            background: #fff;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,51,102,0.06);
            max-height: 500px;
            overflow-y: auto;
        }
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .results-title {
            font-size: 1.5rem;
            font-weight: 900;
            color: #003366;
        }
        .filter-buttons {
            display: flex;
            gap: 10px;
        }
        .filter-btn {
            padding: 8px 16px;
            border: 1.5px solid #bfc9d1;
            background: #f7fafd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            color: #003366;
        }
        .filter-btn.active {
            background: #FFD700;
            color: #003366;
            border-color: #FFD700;
        }
        .station-card {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #006400;
            transition: all 0.2s ease;
            cursor: pointer;
            box-shadow: 0 1px 4px rgba(0,51,102,0.04);
        }
        .station-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,51,102,0.08);
        }
        .station-card.pso {
            border-left-color: #006400;
            background: #f7fafd;
        }
        .station-card.competitor {
            border-left-color: #003366;
            background: #fff;
        }
        .station-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }
        .station-name {
            font-size: 1.2rem;
            font-weight: 900;
            color: #003366;
        }
        .station-brand {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .station-brand.pso {
            background: #006400;
            color: #FFD700;
        }
        .station-brand.competitor {
            background: #003366;
            color: #FFD700;
        }
        .station-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        .detail-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #003366;
        }
        .detail-item i {
            color: #003366;
        }
        .station-services {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .service-tag {
            background: #e3e8ee;
            color: #003366;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #003366;
        }
        .loading i {
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }
        .error {
            text-align: center;
            padding: 40px;
            color: #B22222;
        }
        .error i {
            font-size: 2rem;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="pso-logo"><img src="assets/logos/pso.png" alt="PSO Logo"></div>
            <h1>PSO Market Analysis</h1>
            <p style="color:#fff; font-weight:500; font-size:1.08rem; margin-bottom:0;">Find real fuel stations within your selected radius with competitive analysis</p>
        </div>

        <div class="search-container">
            <div class="search-form">
                <div class="input-group">
                    <label for="latitude">Latitude</label>
                    <input type="number" id="latitude" placeholder="25.3730" step="any">
                </div>
                <div class="input-group">
                    <label for="longitude">Longitude</label>
                    <input type="number" id="longitude" placeholder="68.3512" step="any">
                </div>
                <div class="input-group">
                    <label for="radius">Radius (km)</label>
                    <input type="number" id="radius" placeholder="2" value="2" min="1" max="10" step="0.1">
                </div>
                <button class="search-btn" onclick="searchStations()" id="searchBtn">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
            <div id="site-status" style="margin-top: 10px; text-align: center; font-weight: bold; font-size: 1.1rem;"></div>
        </div>

        <div class="main-content">
            <div class="map-container">
                <div id="map"></div>
                <!-- Site Analysis Below Map -->
                <div class="site-analysis-below-map" id="site-analysis-container" style="display:none;">
                    <div class="site-analysis-title">
                        <i class="fas fa-chart-bar"></i>
                        Site Analysis
                    </div>
                    <div class="site-status-row" id="site-status-below"></div>
                    <div class="site-analysis-grid">
                        <div class="site-analysis-item">
                            <div class="site-analysis-icon"><i class="fas fa-hospital"></i></div>
                            <div class="site-analysis-label">Hospitals</div>
                            <div class="site-analysis-count" id="count-hospitals">0</div>
                        </div>
                        <div class="site-analysis-item">
                            <div class="site-analysis-icon"><i class="fas fa-utensils"></i></div>
                            <div class="site-analysis-label">Restaurants</div>
                            <div class="site-analysis-count" id="count-restaurants">0</div>
                        </div>
                        <div class="site-analysis-item">
                            <div class="site-analysis-icon"><i class="fas fa-university"></i></div>
                            <div class="site-analysis-label">Universities/Schools</div>
                            <div class="site-analysis-count" id="count-educational">0</div>
                        </div>
                        <div class="site-analysis-item">
                            <div class="site-analysis-icon"><i class="fas fa-shopping-bag"></i></div>
                            <div class="site-analysis-label">Malls/Markets</div>
                            <div class="site-analysis-count" id="count-malls">0</div>
                        </div>
                        <div class="site-analysis-item">
                            <div class="site-analysis-icon"><i class="fas fa-clinic-medical"></i></div>
                            <div class="site-analysis-label">Clinics/Pharmacies</div>
                            <div class="site-analysis-count" id="count-clinics">0</div>
                        </div>
                        <div class="site-analysis-item">
                            <div class="site-analysis-icon"><i class="fas fa-bank"></i></div>
                            <div class="site-analysis-label">Banks/ATMs</div>
                            <div class="site-analysis-count" id="count-banks">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <div class="stats-container">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="pso-count">0</div>
                            <div class="stat-label">PSO Stations</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="competitor-count">0</div>
                            <div class="stat-label">Competitors</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="total-count">0</div>
                            <div class="stat-label">Total Stations</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="coverage-percent">0%</div>
                            <div class="stat-label">PSO Coverage</div>
                        </div>
                    </div>
                </div>

                <div class="results-container">
                    <div class="results-header">
                        <h3 class="results-title">Fuel Stations</h3>
                        <div class="filter-buttons">
                            <button class="filter-btn active" onclick="filterResults('all')">All</button>
                            <button class="filter-btn" onclick="filterResults('pso')">PSO</button>
                            <button class="filter-btn" onclick="filterResults('competitor')">Others</button>
                        </div>
                    </div>
                    <div id="results-list">
                        <div class="loading">
                            <i class="fas fa-map-marker-alt"></i>
                            <p>Enter coordinates to find fuel stations</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        let map;
        let markers = [];
        let radiusCircle;
        let currentStations = [];
        let currentFilter = 'all';

        // Only allow these brands
        const allowedBrands = [
            'pso', 'caltex', 'shell', 'total', 'hascol', 'byco', 'attock', 'go'
        ];

        // Initialize map
        function initMap() {
            map = L.map('map').setView([25.3730, 68.3512], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            map.on('click', function(e) {
                document.getElementById('latitude').value = e.latlng.lat.toFixed(6);
                document.getElementById('longitude').value = e.latlng.lng.toFixed(6);
            });
        }

        // Main search function
        async function searchStations() {
            const lat = parseFloat(document.getElementById('latitude').value);
            const lng = parseFloat(document.getElementById('longitude').value);
            const radius = parseFloat(document.getElementById('radius').value);

            if (isNaN(lat) || isNaN(lng) || isNaN(radius) || radius <= 0) {
                alert('Please enter valid coordinates and radius');
                return;
            }

            const searchBtn = document.getElementById('searchBtn');
            searchBtn.disabled = true;
            searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Searching...';

            document.getElementById('results-list').innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Searching for fuel stations from OpenStreetMap...</p>
                </div>
            `;
            document.getElementById('site-status').textContent = '';
            document.getElementById('site-analysis-container').style.display = 'none';

            try {
                clearMap();

                // Add search marker
                const searchMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        html: '<i class="fas fa-crosshairs" style="color: #dc2626; font-size: 20px;"></i>',
                        className: 'custom-marker',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(map);

                // Add radius circle
                radiusCircle = L.circle([lat, lng], {
                    color: '#2d8659',
                    fillColor: '#4ade80',
                    fillOpacity: 0.2,
                    radius: radius * 1000
                }).addTo(map);

                // Fetch stations
                const stations = await fetchFuelStations(lat, lng, radius);

                if (stations.length === 0) {
                    document.getElementById('results-list').innerHTML = `
                        <div class="error">
                            <i class="fas fa-exclamation-circle"></i>
                            <p>No fuel stations found within ${radius}km radius</p>
                            <small>Try searching in a different location</small>
                        </div>
                    `;
                } else {
                    currentStations = stations;
                    stations.forEach(station => {
                        addStationMarker(station, lat, lng);
                    });
                    updateStats();
                    updateResultsList();
                }

                map.setView([lat, lng], 14);

                // Fetch land use and area/location type and site analysis
                let areaType = 'N/A';
                let locationType = 'N/A';
                let siteAnalysisCounts = {
                    hospitals: 0,
                    restaurants: 0,
                    educational: 0,
                    malls: 0,
                    clinics: 0,
                    banks: 0
                };
                try {
                    const landUse = await fetchLandUseData(lat, lng);
                    // Parse for areaType and locationType
                    let foundLanduse = null;
                    let foundHighway = null;
                    let foundPlace = null;
                    let foundAmenity = null;
                    // Site analysis: count important amenities
                    for (const el of landUse.elements) {
                        if (el.tags) {
                            // Area/location type
                            if (!foundLanduse && el.tags.landuse) foundLanduse = el.tags.landuse;
                            if (!foundHighway && el.tags.highway) foundHighway = el.tags.highway;
                            if (!foundPlace && el.tags.place) foundPlace = el.tags.place;
                            if (!foundAmenity && el.tags.amenity) foundAmenity = el.tags.amenity;
                            // Site analysis counts
                            if (el.tags.amenity) {
                                const a = el.tags.amenity.toLowerCase();
                                if (a === 'hospital') siteAnalysisCounts.hospitals++;
                                else if (a === 'restaurant' || a === 'fast_food' || a === 'cafe') siteAnalysisCounts.restaurants++;
                                else if (a === 'school' || a === 'university' || a === 'college') siteAnalysisCounts.educational++;
                                else if (a === 'pharmacy' || a === 'clinic' || a === 'doctors') siteAnalysisCounts.clinics++;
                                else if (a === 'bank' || a === 'atm') siteAnalysisCounts.banks++;
                            }
                            if (el.tags.shop) {
                                const s = el.tags.shop.toLowerCase();
                                if (s === 'mall' || s === 'supermarket' || s === 'department_store' || s === 'convenience') siteAnalysisCounts.malls++;
                            }
                            if (el.tags.building) {
                                const b = el.tags.building.toLowerCase();
                                if (b === 'mall' || b === 'supermarket' || b === 'retail') siteAnalysisCounts.malls++;
                                if (b === 'hospital') siteAnalysisCounts.hospitals++;
                                if (b === 'school' || b === 'university' || b === 'college') siteAnalysisCounts.educational++;
                            }
                        }
                    }
                    // Area type
                    if (foundLanduse) {
                        const lut = {
                            'residential': 'Residential',
                            'commercial': 'Commercial',
                            'industrial': 'Industrial',
                            'retail': 'Retail',
                            'farmland': 'Farmland',
                            'forest': 'Forest',
                            'recreational': 'Recreational',
                            'educational': 'Educational',
                            'healthcare': 'Healthcare'
                        };
                        areaType = lut[foundLanduse] || (foundLanduse.charAt(0).toUpperCase() + foundLanduse.slice(1));
                    }
                    // Location type
                    if (foundHighway) {
                        locationType = 'Highway';
                    } else if (foundPlace) {
                        locationType = 'City';
                    } else if (foundAmenity && foundAmenity === 'fuel') {
                        locationType = 'Fuel Area';
                    } else {
                        locationType = 'City';
                    }
                } catch (e) {
                    areaType = 'N/A';
                    locationType = 'N/A';
                }
                // Update site analysis UI below the map
                let siteStatus = `Location Type: <b>${locationType}</b> &nbsp; | &nbsp; Area Type: <b>${areaType}</b>`;
                document.getElementById('site-status-below').innerHTML = siteStatus;
                document.getElementById('site-status-below').style.color = '#003366';

                document.getElementById('count-hospitals').textContent = siteAnalysisCounts.hospitals;
                document.getElementById('count-restaurants').textContent = siteAnalysisCounts.restaurants;
                document.getElementById('count-educational').textContent = siteAnalysisCounts.educational;
                document.getElementById('count-malls').textContent = siteAnalysisCounts.malls;
                document.getElementById('count-clinics').textContent = siteAnalysisCounts.clinics;
                document.getElementById('count-banks').textContent = siteAnalysisCounts.banks;
                document.getElementById('site-analysis-container').style.display = 'block';

            } catch (error) {
                console.error('Error fetching fuel stations:', error);
                document.getElementById('results-list').innerHTML = `
                    <div class="error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error loading fuel stations</p>
                        <small>Please try again or check your internet connection</small>
                    </div>
                `;
                document.getElementById('site-analysis-container').style.display = 'none';
            } finally {
                searchBtn.disabled = false;
                searchBtn.innerHTML = '<i class="fas fa-search"></i> Search';
            }
        }

        // Fetch fuel stations from Overpass API, only allowed brands
        async function fetchFuelStations(lat, lng, radius) {
            // Overpass API query for fuel stations (circular search)
            const query = `
                [out:json][timeout:30];
                (
                  node["amenity"="fuel"](around:${radius * 1000},${lat},${lng});
                  way["amenity"="fuel"](around:${radius * 1000},${lat},${lng});
                  relation["amenity"="fuel"](around:${radius * 1000},${lat},${lng});
                );
                out geom;
            `;

            const overpassUrl = 'https://overpass-api.de/api/interpreter';
            try {
                const response = await fetch(overpassUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'data=' + encodeURIComponent(query)
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch data from Overpass API');
                }

                const data = await response.json();

                // Only allow stations with allowed brands
                return data.elements.map(element => {
                    let stationLat, stationLng;
                    if (element.type === 'node') {
                        stationLat = element.lat;
                        stationLng = element.lon;
                    } else if (element.type === 'way' && element.geometry) {
                        stationLat = element.geometry[0].lat;
                        stationLng = element.geometry[0].lon;
                    } else {
                        return null;
                    }

                    const distance = calculateDistance(lat, lng, stationLat, stationLng);
                    if (distance > radius) return null;

                    const tags = element.tags || {};
                    const brand = determineBrand(tags);
                    if (!allowedBrands.includes(brand.toLowerCase())) return null;

                    return {
                        id: element.id,
                        name: tags.name || tags.brand || `${brand} Station`,
                        brand: brand,
                        lat: stationLat,
                        lng: stationLng,
                        distance: distance,
                        address: formatAddress(tags),
                        phone: tags.phone || 'N/A',
                        services: determineServices(tags),
                        rating: 4.0,
                        price: getEstimatedPrice(brand),
                        opening_hours: tags.opening_hours || 'N/A',
                        operator: tags.operator || tags.brand || brand
                    };
                }).filter(station => station !== null);

            } catch (error) {
                console.error('Error fetching from Overpass API:', error);
                throw error;
            }
        }

        // Fetch land use and area/location type using Overpass API
        async function fetchLandUseData(lat, lon) {
            const query = `
        [out:json][timeout:25];
        (
        way["landuse"~"residential|commercial|industrial|retail|farmland|forest|recreational|educational|healthcare"](around:1000,${lat},${lon});
        relation["landuse"~"residential|commercial|industrial|retail|farmland|forest|recreational|educational|healthcare"](around:1000,${lat},${lon});
        way["amenity"~"school|hospital|university|clinic|pharmacy|bank|restaurant|fuel|fast_food|cafe|college|atm"](around:1000,${lat},${lon});
        way["building"~"residential|commercial|industrial|retail|office|hospital|school|university|mall|supermarket|department_store"](around:1000,${lat},${lon});
        way["shop"~"mall|supermarket|department_store|convenience"](around:1000,${lat},${lon});
        );
        (._;>;);
        out body;
    `;
            const overpassUrl = 'https://overpass-api.de/api/interpreter';
            const response = await fetch(overpassUrl, {
                method: 'POST',
                body: query,
                headers: {
                    'Content-Type': 'text/plain',
                },
            });
            if (!response.ok) throw new Error('Failed to fetch land use data');
            return await response.json();
        }

        // Brand detection (only allowed brands returned)
        function determineBrand(tags) {
            let brand = tags.brand || tags.operator || tags.name || '';
            // Urdu to English
            if (/پاکستان اسٹیٹ آئل|پی ایس او|پی،ایس،او/i.test(brand)) return 'PSO';
            if (/شیل/i.test(brand)) return 'Shell';
            if (/طوطال|ٹوٹل|ٹوٹل پارکو/i.test(brand)) return 'Total';
            if (/اٹک|اٹک پیٹرولیم/i.test(brand)) return 'Attock';
            if (/ہیسکول/i.test(brand)) return 'Hascol';
            if (/پارکو/i.test(brand)) return 'Parco';
            if (/کیلٹیکس/i.test(brand)) return 'Caltex';
            if (/جی او|گو|گیس اینڈ آئل/i.test(brand)) return 'GO';
            // English/variant
            const lower = brand.toLowerCase();
            if (lower.includes('pso') || lower.includes('pakistan state oil')) return 'PSO';
            if (lower.includes('shell')) return 'Shell';
            if (lower.includes('total')) return 'Total';
            if (lower.includes('attock')) return 'Attock';
            if (lower.includes('hascol')) return 'Hascol';
            if (lower.includes('parco')) return 'Parco';
            if (lower.includes('caltex')) return 'Caltex';
            if (lower.includes('byco')) return 'Byco';
            if (lower.includes('go') || lower.includes('gas & oil') || lower.includes('gas and oil')) return 'GO';
            return '';
        }

        function formatAddress(tags) {
            const parts = [];
            if (tags['addr:street']) parts.push(tags['addr:street']);
            if (tags['addr:city']) parts.push(tags['addr:city']);
            if (tags['addr:state']) parts.push(tags['addr:state']);
            return parts.length > 0 ? parts.join(', ') : 'Address not available';
        }

        function determineServices(tags) {
            const services = [];
            services.push('Petrol');
            if (tags.fuel === 'yes' || tags['fuel:diesel'] === 'yes') services.push('Diesel');
            if (tags['fuel:lpg'] === 'yes') services.push('LPG');
            if (tags.compressed_air === 'yes') services.push('Air Pump');
            if (tags.car_wash === 'yes') services.push('Car Wash');
            if (tags.shop === 'convenience') services.push('Convenience Store');
            if (tags.atm === 'yes') services.push('ATM');
            if (tags.repair === 'yes') services.push('Service Center');
            if (tags.restaurant === 'yes' || tags.amenity === 'restaurant') services.push('Restaurant');
            return services.length > 1 ? services : ['Petrol', 'Diesel'];
        }

        function getEstimatedPrice(brand) {
            const prices = {
                'PSO': 272.50,
                'Shell': 275.00,
                'Total': 274.00,
                'Attock': 273.50,
                'Hascol': 273.00,
                'Parco': 274.50,
                'Caltex': 275.50,
                'Byco': 273.00,
                'GO': 273.00
            };
            return prices[brand] || 270.00;
        }

        function addStationMarker(station, searchLat, searchLng) {
            const brandKey = station.brand.toLowerCase();
            const logoMap = {
                'pso': '/assets/logos/pso.png',
                'shell': '/assets/logos/shell.png',
                'total': '/assets/logos/total.png',
                'attock': '/assets/logos/attock.png',
                'hascol': '/assets/logos/hascol.png',
                'parco': '/assets/logos/parco.png',
                'caltex': '/assets/logos/caltex.png',
                'byco': '/assets/logos/byco.png',
                'go': '/assets/logos/go.png'
            };
            const iconUrl = logoMap[brandKey] || '/assets/logos/default.png';

            const marker = L.marker([station.lat, station.lng], {
                icon: L.icon({
                    iconUrl: iconUrl,
                    iconSize: [32, 32],
                    iconAnchor: [16, 32],
                    popupAnchor: [0, -28]
                })
            }).addTo(map);

            marker.bindPopup(`
                <div style="min-width: 250px;">
                    <h4 style="margin: 0 0 10px 0; color: #0f4c3a;">${station.name}</h4>
                    <p style="margin: 0; color: #64748b; font-size: 0.9rem;">${station.address}</p>
                    <p style="margin: 5px 0; font-weight: 600;">Distance: ${station.distance.toFixed(2)} km</p>
                    <p style="margin: 5px 0; font-weight: 600;">Price: Rs. ${station.price}/L</p>
                    ${station.phone !== 'N/A' ? `<p style="margin: 5px 0;">Phone: ${station.phone}</p>` : ''}
                    ${station.opening_hours !== 'N/A' ? `<p style="margin: 5px 0;">Hours: ${station.opening_hours}</p>` : ''}
                    <div style="margin: 10px 0;">
                        <img src="${iconUrl}" alt="${station.brand} logo" style="height: 24px; vertical-align: middle; margin-right: 8px;">
                        <span style="background: #0f4c3a; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem;">
                            ${station.brand}
                        </span>
                    </div>
                </div>
            `);

            markers.push(marker);

            if (searchLat && searchLng) {
                const isPSO = brandKey === 'pso';
                L.polyline([
                    [searchLat, searchLng],
                    [station.lat, station.lng]
                ], {
                    color: isPSO ? '#166534' : '#dc2626',
                    weight: isPSO ? 3 : 2,
                    opacity: 0.8,
                    dashArray: isPSO ? null : '5, 5'
                }).addTo(map);
            }
        }

        function clearMap() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            if (radiusCircle) {
                map.removeLayer(radiusCircle);
            }
            map.eachLayer(function(layer) {
                if (layer._url) return;
                map.removeLayer(layer);
            });
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function updateStats() {
            const psoStations = currentStations.filter(s => s.brand.toLowerCase() === 'pso');
            const competitorStations = currentStations.filter(s => s.brand.toLowerCase() !== 'pso');
            const total = currentStations.length;
            const coverage = total > 0 ? Math.round((psoStations.length / total) * 100) : 0;

            document.getElementById('pso-count').textContent = psoStations.length;
            document.getElementById('competitor-count').textContent = competitorStations.length;
            document.getElementById('total-count').textContent = total;
            document.getElementById('coverage-percent').textContent = coverage + '%';
        }

        function updateResultsList() {
            const resultsList = document.getElementById('results-list');
            if (currentStations.length === 0) {
                resultsList.innerHTML = `
                    <div class="error">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>No fuel stations found within ${document.getElementById('radius').value}km radius</p>
                    </div>
                `;
                return;
            }
            let filteredStations = currentStations;
            if (currentFilter === 'pso') {
                filteredStations = currentStations.filter(s => s.brand.toLowerCase() === 'pso');
            } else if (currentFilter === 'competitor') {
                filteredStations = currentStations.filter(s => s.brand.toLowerCase() !== 'pso');
            }
            filteredStations.sort((a, b) => a.distance - b.distance);

            const html = filteredStations.map(station => {
                const isPSO = station.brand.toLowerCase() === 'pso';
                return `
                    <div class="station-card ${isPSO ? 'pso' : 'competitor'}" onclick="focusStation(${station.lat}, ${station.lng})">
                        <div class="station-header">
                            <h4 class="station-name">${station.name}</h4>
                            <span class="station-brand ${isPSO ? 'pso' : 'competitor'}">${station.brand}</span>
                        </div>
                        <div class="station-details">
                            <div class="detail-item">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>${station.distance.toFixed(1)} km</span>
                            </div>
                            ${station.phone !== 'N/A' ? `
                            <div class="detail-item">
                                <i class="fas fa-phone"></i>
                                <span>${station.phone}</span>
                            </div>
                            ` : ''}
                            <div class="detail-item">
                                <i class="fas fa-star"></i>
                                <span>${station.rating}/5</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-money-bill-wave"></i>
                                <span>Rs. ${station.price}/L</span>
                            </div>
                        </div>
                        <div class="station-services">
                            ${station.services.map(service => `<span class="service-tag">${service}</span>`).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            resultsList.innerHTML = html;
        }

        function filterResults(type) {
            currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updateResultsList();
        }

        function focusStation(lat, lng) {
            map.setView([lat, lng], 16);
        }

        document.addEventListener('DOMContentLoaded', function() {
            initMap();
        });
    </script>
</body>
</html>